// Weather via Open-Meteo (current + 3-day)
async function getWeather(lat, lon) {
lastLat = lat; lastLon = lon;
document.getElementById("lat-val").textContent = Number(lat).toFixed(2);
document.getElementById("lon-val").textContent = Number(lon).toFixed(2);

const unit = document.getElementById('unit').value; // metric/imperial
const useF = unit === 'imperial';

const url = new URL("https://api.open-meteo.com/v1/forecast");
url.searchParams.set("latitude", lat);
url.searchParams.set("longitude", lon);
url.searchParams.set("current_weather", "true");
url.searchParams.set("temperature_unit", useF ? "fahrenheit" : "celsius");
url.searchParams.set("wind_speed_unit", useF ? "mph" : "kmh");
url.searchParams.set("daily", "weathercode,temperature_2m_max,temperature_2m_min");
url.searchParams.set("forecast_days", "3");
url.searchParams.set("timezone", "auto");

// --- ensure shimmer is visible for a moment ---
const MIN_LOAD_MS = 700; // tweak if you want longer/shorter
const start = performance.now();
setLoading(true);

try {
const res = await fetch(url.toString());
if (!res.ok) throw new Error(`Weather fetch failed: ${res.status}`);
const data = await res.json();

// Guarantee shimmer shows at least MIN_LOAD_MS
const elapsed = performance.now() - start;
if (elapsed < MIN_LOAD_MS) { await new Promise(r=> setTimeout(r, MIN_LOAD_MS - elapsed));
    }

    // Current
    const temp = data?.current_weather?.temperature ?? "?";
    const wind = data?.current_weather?.windspeed ?? "?";
    const code = data?.current_weather?.weathercode ?? null;
    document.getElementById("temp-val").textContent = `${temp} °${useF ? "F" : "C"}`;
    document.getElementById("cond-val").textContent = weatherCodeToText(code);
    document.getElementById("wind-val").textContent = `${wind} ${useF ? "mph" : "km/h"}`;

    // Forecast
    const days = data?.daily ?? {};
    const dates = days.time || [];
    const tmax = days.temperature_2m_max || [];
    const tmin = days.temperature_2m_min || [];
    const wcode = days.weathercode || [];

    const f = document.getElementById('forecast');
    f.innerHTML = dates.map((d, i) => `
    <div class="day">
        <div class="muted">${formatDateISO(d)}</div>
        <div><strong>${weatherCodeToText(wcode[i])}</strong></div>
        <div class="muted">High / Low</div>
        <div><strong>${tmax[i]}° / ${tmin[i]}° ${useF ? "F" : "C"}</strong></div>
    </div>
    `).join('');
    } catch (err) {
    console.error(err);
    alert("Could not fetch weather right now.");
    } finally {
    setLoading(false);
    }
    }