<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Dashboard (Keyless)</title>
    <link rel="stylesheet" href="style.css" />

    <!-- Leaflet (OpenStreetMap) - no API key required -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        h1 {
            color: #2b6cb0;
            text-align: center;
            margin-bottom: 12px;
        }

        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin: 12px 0;
        }

        .row label {
            min-width: 90px;
        }

        input[type="text"] {
            padding: 6px 8px;
        }

        select,
        button {
            padding: 8px 12px;
        }

        button {
            background: #2b6cb0;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        #weather-info {
            margin-top: 12px;
        }
    </style>
</head>

<body>
    <h1>Weather Dashboard</h1>
    <h2>Click the map or search a city</h2>

    <!-- Controls -->
    <div class="row">
        <label for="city">City:</label>
        <input type="text" id="city" placeholder="e.g., Boston">
        <button onclick="searchCity()">Search</button>

        <label for="unit">Units:</label>
        <select id="unit" onchange="refetchLast()">
            <option value="metric" selected>°C / km/h</option>
            <option value="imperial">°F / mph</option>
        </select>
    </div>

    <div class="row">
        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" placeholder="Enter latitude">
        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" placeholder="Enter longitude">
        <button onclick="getWeatherFromInputs()">Get Weather</button>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Weather output -->
    <div id="weather-info">
        <p><strong>Latitude:</strong> 42.36</p>
        <p><strong>Longitude:</strong> -71.06</p>
        <p><strong>Temperature:</strong> 22 °C</p>
        <p><strong>Condition:</strong> Clear sky</p>
        <p><strong>Wind Speed:</strong> 10 km/h</p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Keep track of last lat/lon so changing units re-fetches for the same spot
        let lastLat = 42.3601, lastLon = -71.0589;

        // --- Keyless Weather via Open-Meteo ---
        async function getWeather(lat, lon) {
            lastLat = lat; lastLon = lon;

            const unit = document.getElementById('unit').value; // "metric" or "imperial"
            const useF = unit === 'imperial';

            const url = new URL("https://api.open-meteo.com/v1/forecast");
            url.searchParams.set("latitude", lat);
            url.searchParams.set("longitude", lon);
            url.searchParams.set("current_weather", "true");
            url.searchParams.set("temperature_unit", useF ? "fahrenheit" : "celsius");
            url.searchParams.set("wind_speed_unit", useF ? "mph" : "kmh");

            try {
                const res = await fetch(url.toString());
                if (!res.ok) throw new Error(`Weather fetch failed: ${res.status}`);
                const data = await res.json();

                const temp = data?.current_weather?.temperature ?? "?";
                const wind = data?.current_weather?.windspeed ?? "?";
                const code = data?.current_weather?.weathercode ?? null;

                document.getElementById("weather-info").innerHTML = `
          <h3>Weather Details</h3>
          <p><strong>Latitude:</strong> ${Number(lat).toFixed(2)}</p>
          <p><strong>Longitude:</strong> ${Number(lon).toFixed(2)}</p>
          <p><strong>Temperature:</strong> ${temp} °${useF ? "F" : "C"}</p>
          <p><strong>Condition:</strong> ${weatherCodeToText(code)}</p>
          <p><strong>Wind Speed:</strong> ${wind} ${useF ? "mph" : "km/h"}</p>
        `;
            } catch (err) {
                console.error(err);
                alert("Could not fetch weather right now.");
            }
        }

        function weatherCodeToText(code) {
            const map = {
                0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
                45: "Fog", 48: "Depositing rime fog",
                51: "Light drizzle", 53: "Moderate drizzle", 55: "Dense drizzle",
                61: "Slight rain", 63: "Moderate rain", 65: "Heavy rain",
                71: "Slight snow", 73: "Moderate snow", 75: "Heavy snow",
                95: "Thunderstorm", 99: "Thunderstorm with hail"
            };
            return map[code] ?? "Unknown";
        }

        function getWeatherFromInputs() {
            const lat = parseFloat(document.getElementById("latitude").value);
            const lon = parseFloat(document.getElementById("longitude").value);
            if (!isNaN(lat) && !isNaN(lon)) {
                map.setView([lat, lon], 10);
                marker.setLatLng([lat, lon]);
                getWeather(lat, lon);
            } else {
                alert("Please enter valid coordinates.");
            }
        }

        async function searchCity() {
            const q = document.getElementById("city").value?.trim();
            if (!q) return alert("Enter a city name.");
            try {
                // Nominatim (OpenStreetMap) geocoding — no API key
                const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(q)}`;
                const res = await fetch(url, { headers: { /* Referer will be set automatically */ } });
                if (!res.ok) throw new Error("Geocoding failed");
                const results = await res.json();
                if (!results.length) return alert("City not found. Try a more specific query.");
                const { lat, lon, display_name } = results[0];
                map.setView([+lat, +lon], 11);
                marker.setLatLng([+lat, +lon]);
                getWeather(+lat, +lon);
            } catch (e) {
                console.error(e);
                alert("Could not find that city.");
            }
        }

        function refetchLast() {
            getWeather(lastLat, lastLon);
        }

        // --- Leaflet Map (no key) ---
        const map = L.map('map').setView([lastLat, lastLon], 9); // Boston default
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const marker = L.marker([lastLat, lastLon]).addTo(map);

        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            marker.setLatLng([lat, lng]);
            getWeather(lat, lng);
        });

        // Initial fetch
        getWeather(lastLat, lastLon);
    </script>
</body>

</html>